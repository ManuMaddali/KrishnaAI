<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#FF9933">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>KrishnaAI - Spiritual Guide</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add favicon -->
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <!-- Add apple touch icon -->
    <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
    <!-- PWA manifest -->
    <link rel="manifest" href="/static/manifest.json">
    <style>
        :root {
            --primary-color: #FF9933; /* Saffron color from Indian flag */
            --secondary-color: #138808; /* Green color from Indian flag */
            --accent-color: #6A0DAD; /* Deep purple, representing divinity */
            --text-color: #333;
            --light-color: #FFF7E6; /* Light cream background */
            --dark-orange: #e06000;
            --highlight: #FFD700; /* Golden yellow */
            --message-bg: rgba(255, 153, 51, 0.1); /* Light saffron for message bg */
            --krishna-message-bg: rgba(106, 13, 173, 0.08); /* Light purple for Krishna's messages */
            --border-color: #FFB266; /* Lighter saffron for borders */
            --gradient-light: linear-gradient(135deg, #FF9933, #FFB266);
            --gradient-dark: linear-gradient(135deg, #FF9933, #e06000);
            --spiritual-blue: #4169E1; /* Royal blue - representing Krishna */
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--light-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
        }
        
        /* Sidebar for conversations */
        .sidebar {
            width: 320px;
            background: linear-gradient(to bottom, #FFF, var(--light-color));
            border-right: 1px solid var(--border-color);
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }
        
        .sidebar-header {
            padding: 18px 15px;
            background: var(--gradient-dark);
            color: white;
            text-align: center;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--highlight);
        }
        
        .sidebar-title {
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sort-controls {
            padding: 12px 15px;
            background-color: rgba(255, 153, 51, 0.05);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sort-dropdown {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            outline: none;
            font-size: 14px;
            cursor: pointer;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .conversation-list {
            flex: 1;
            overflow-y: auto;
            padding: 5px 0;
        }
        
        .conversation-item {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 153, 51, 0.2);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .conversation-item:hover {
            background-color: var(--message-bg);
        }
        
        .conversation-item.active {
            background-color: var(--message-bg);
            border-left: 3px solid var(--primary-color);
        }
        
        .conversation-title {
            font-weight: 500;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .conversation-title i {
            color: var(--primary-color);
        }
        
        .conversation-date {
            font-size: 12px;
            color: #777;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .conversation-date i {
            font-size: 10px;
            color: #999;
        }
        
        .conversation-preview {
            margin-top: 5px;
            font-size: 13px;
            color: #555;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.3;
        }
        
        .new-chat-btn {
            margin: 15px;
            padding: 12px;
            background: var(--gradient-dark);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        
        .new-chat-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* Main chat area */
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: relative;
            background: linear-gradient(to bottom, var(--light-color), #FFF);
        }
        
        .chat-header {
            padding: 15px 20px;
            background: var(--gradient-dark);
            border-bottom: 3px solid var(--highlight);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .header-title {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-title span {
            color: var(--highlight);
        }
        
        .krishna-icon {
            font-size: 24px;
            color: var(--highlight);
        }
        
        .menu-toggle {
            display: none;
            cursor: pointer;
            font-size: 24px;
            color: white;
        }
        
        .chat-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: transparent;
            background-image: url('https://www.transparenttextures.com/patterns/diamond-upholstery.png');
            background-blend-mode: overlay;
        }
        
        .message {
            display: flex;
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        .user-message {
            justify-content: flex-end;
        }
        
        .krishna-message {
            justify-content: flex-start;
        }
        
        .message-bubble {
            max-width: 80%;
            padding: 15px;
            border-radius: 18px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-size: 15px;
            line-height: 1.5;
        }
        
        .user-bubble {
            background-color: var(--message-bg);
            border-bottom-right-radius: 5px;
            border: 1px solid rgba(255, 153, 51, 0.3);
        }
        
        .krishna-bubble {
            background-color: var(--krishna-message-bg);
            border-bottom-left-radius: 5px;
            color: var(--text-color);
            border: 1px solid rgba(106, 13, 173, 0.2);
        }
        
        .input-container {
            padding: 15px 20px;
            background-color: white;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        
        #user-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 25px;
            outline: none;
            font-size: 15px;
            resize: none;
            max-height: 120px;
            min-height: 24px;
            line-height: 24px;
            background-color: rgba(255, 247, 230, 0.5);
            transition: all 0.2s;
        }
        
        #user-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(255, 153, 51, 0.2);
        }
        
        .send-btn {
            margin-left: 10px;
            padding: 10px 20px;
            background: var(--gradient-dark);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .send-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .reset-btn {
            margin-left: 10px;
            padding: 10px;
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--border-color);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .reset-btn:hover {
            background-color: var(--message-bg);
            color: var(--dark-orange);
            transform: translateY(-2px);
        }
        
        .typing-indicator {
            display: none;
            margin-top: 10px;
            padding: 10px 15px;
            background-color: var(--krishna-message-bg);
            border-radius: 18px;
            border-bottom-left-radius: 5px;
            width: fit-content;
            font-size: 14px;
            color: var(--text-color);
            animation: pulse 1.5s infinite;
            border: 1px solid rgba(106, 13, 173, 0.2);
        }
        
        .empty-state {
            text-align: center;
            color: #777;
            padding: 30px 20px;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .empty-state i {
            font-size: 24px;
            color: var(--border-color);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        
        /* Responsive styles */
        @media screen and (max-width: 768px) {
            .menu-toggle {
                display: block;
            }
            
            .sidebar {
                position: fixed;
                left: -320px;
                z-index: 10;
                box-shadow: 0 0 15px rgba(0,0,0,0.2);
                transition: left 0.3s ease;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            body.sidebar-open::after {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 5;
            }
        }
        
        .delete-all-btn {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            padding: 5px;
            transition: all 0.2s;
        }
        
        .delete-all-btn:hover {
            color: #ff6b6b;
            transform: scale(1.1);
        }
        
        .conversation-controls {
            display: flex;
            gap: 5px;
            margin-left: auto;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .conversation-item:hover .conversation-controls {
            opacity: 1;
        }
        
        .delete-conversation-btn {
            background: none;
            border: none;
            color: #999;
            font-size: 14px;
            cursor: pointer;
            padding: 3px;
            transition: all 0.2s;
        }
        
        .delete-conversation-btn:hover {
            color: #ff6b6b;
            transform: scale(1.1);
        }
        
        /* Tabs for sidebar */
        .sidebar-tabs {
            display: flex;
            background-color: rgba(255, 153, 51, 0.1);
            border-bottom: 1px solid var(--border-color);
        }
        
        .sidebar-tab {
            flex: 1;
            text-align: center;
            padding: 12px 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            color: #777;
            transition: all 0.2s;
        }
        
        .sidebar-tab.active {
            background-color: rgba(255, 153, 51, 0.2);
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }
        
        .sidebar-tab:hover:not(.active) {
            background-color: rgba(255, 153, 51, 0.05);
            color: var(--dark-orange);
        }
        
        .sidebar-content {
            display: none;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }
        
        .sidebar-content.active {
            display: flex;
        }
        
        /* Scripture styles */
        .scripture-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .scripture-item {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 153, 51, 0.2);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
        }
        
        .scripture-item:hover {
            background-color: var(--message-bg);
        }
        
        .scripture-title {
            font-weight: 500;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--accent-color);
        }
        
        .scripture-container {
            display: none;
            flex-direction: column;
            height: 100%;
            max-height: calc(100vh - 60px); /* Prevent container from expanding beyond viewport */
            overflow: hidden; /* Prevent container from expanding */
        }
        
        .scripture-container.active {
            display: flex;
        }
        
        .scripture-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 1rem;
        }
        
        .scripture-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #FF9933; /* Saffron color */
        }
        
        .scripture-controls {
            position: absolute;
            top: 15px;
            right: 70px;
            z-index: 10;
        }
        
        .scripture-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f9f5eb;
            border-radius: 8px;
            line-height: 1.6;
        }
        
        .scripture-paragraph {
            margin-bottom: 1rem;
            text-align: justify;
        }
        
        .verse-num {
            position: absolute;
            left: 0;
            top: 0;
            font-weight: bold;
            color: #FF9933;
            margin-right: 0.5rem;
        }
        
        .scripture-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
        }
        
        .nav-button {
            padding: 0.5rem 1rem;
            background-color: #FF9933;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .nav-button:hover {
            background-color: #e88a2a;
        }
        
        .nav-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .back-to-chat {
            margin-left: auto;
            padding: 0.5rem 1rem;
            background-color: #138808; /* Green color */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .scripture-reference {
            display: inline-flex;
            align-items: center;
            color: #FF9933;
            background-color: rgba(255, 153, 51, 0.1);
            border-radius: 4px;
            padding: 0.2rem 0.5rem;
            margin: 0 0.2rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .scripture-reference:hover {
            background-color: rgba(255, 153, 51, 0.2);
        }
        
        .scripture-reference i {
            margin-right: 0.3rem;
        }
        
        /* Main chat scripture view */
        .main-scripture-container {
            display: none;
            flex-direction: column;
            height: 100%;
            background-color: #FFF7E6;
            padding: 20px;
            overflow-y: auto;
        }
        
        /* Make sure this class isn't used since we're using display property directly */
        .main-scripture-container.active {
            display: flex !important;
        }
        
        .scripture-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .scripture-header h3 {
            margin: 0;
            color: var(--accent-color);
            font-size: 18px;
        }
        
        .scripture-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }
        
        .scripture-navigation button {
            padding: 5px 10px;
            background: var(--gradient-light);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .scripture-navigation button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .scripture-navigation .page-info {
            display: flex;
            align-items: center;
            color: #777;
            font-size: 14px;
        }
        
        .scripture-content {
            flex: 1;
            overflow-y: auto;
            line-height: 1.6;
            font-size: 15px;
            white-space: pre-wrap;
        }
        
        .main-scripture-content {
            flex: 1;
            overflow-y: auto;
            line-height: 1.8;
            font-size: 16px;
            font-family: 'Poppins', sans-serif;
            color: #333;
            padding: 20px 30px;
            background-color: #FFF7E6;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            max-height: calc(100vh - 180px);
        }
        
        .main-scripture-content p {
            margin-bottom: 22px;
            text-align: left;
            position: relative;
            padding-left: 40px;
            font-size: 16px;
            line-height: 1.8;
            white-space: normal;
            word-wrap: break-word;
        }
        
        .verse-num {
            position: absolute;
            left: 0;
            top: 0;
            font-weight: 600;
            color: var(--primary-color);
            width: 30px;
            text-align: center;
            font-size: 14px;
            opacity: 0.8;
            background-color: rgba(255, 153, 51, 0.1);
            border-radius: 3px;
            padding: 0 5px;
        }
        
        .scripture-controls {
            position: absolute;
            top: 15px;
            right: 70px;
            z-index: 10;
        }
        
        .fullscreen-btn {
            background: var(--gradient-light);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .fullscreen-btn:hover {
            background: var(--gradient-dark);
        }
        
        /* Fullscreen modal */
        .scripture-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #FFF7E6;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .scripture-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .scripture-modal-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--accent-color);
        }
        
        .scripture-modal-close {
            background: var(--gradient-dark);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .scripture-modal-content {
            line-height: 1.8;
            font-size: 18px;
            max-width: 800px;
            margin: 0 auto;
            white-space: normal;
            word-wrap: break-word;
            padding: 30px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.1);
        }
        
        .scripture-modal-content p {
            margin-bottom: 24px;
            text-align: left;
            position: relative;
            padding-left: 45px;
            font-size: 18px;
            line-height: 1.8;
        }
        
        .scripture-modal-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            max-width: 800px;
            margin: 20px auto 0;
        }
        
        .scripture-reference {
            display: inline-block;
            margin-top: 8px;
            font-size: 13px;
            color: var(--secondary-color);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .scripture-reference:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }
        
        /* Scripture main view styles */
        .scripture-main-container {
            display: none;
            flex-direction: column;
            height: 100%;
            background-color: var(--cream-color);
            color: var(--dark-brown);
            padding: 1rem;
            overflow: hidden;
        }
        
        .scripture-main-container.active {
            display: flex;
        }
        
        .scripture-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
        }
        
        .scripture-header button {
            background-color: var(--saffron-color);
            color: var(--dark-brown);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .scripture-header button:hover {
            background-color: var(--dark-saffron-color);
        }
        
        .scripture-header h2 {
            margin: 0;
            flex-grow: 1;
            text-align: center;
            font-size: 1.5rem;
        }
        
        .scripture-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            line-height: 1.6;
        }
        
        .scripture-content p {
            margin-bottom: 1rem;
        }
        
        .scripture-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }
        
        .scripture-navigation button {
            background-color: var(--saffron-color);
            color: var(--dark-brown);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .scripture-navigation button:disabled {
            background-color: #e0e0e0;
            color: #909090;
            cursor: not-allowed;
        }
        
        .scripture-navigation button:not(:disabled):hover {
            background-color: var(--dark-saffron-color);
        }
        
        .verse-num {
            font-weight: bold;
            color: var(--saffron-color);
            margin-right: 0.3rem;
        }
        
        .scripture-ref {
            display: inline-block;
            background-color: rgba(255, 153, 0, 0.1);
            border-radius: 4px;
            padding: 0 0.3rem;
            margin: 0 0.2rem;
            border-bottom: 1px dashed var(--saffron-color);
            cursor: pointer;
            color: var(--dark-saffron-color);
        }
        
        .scripture-ref:hover {
            background-color: rgba(255, 153, 0, 0.2);
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            color: var(--dark-brown);
            font-style: italic;
            gap: 0.5rem;
        }
        
        .scripture-debug {
            background-color: rgba(255, 153, 51, 0.1);
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
            border-left: 3px solid var(--primary-color);
            font-size: 13px;
            color: #666;
            font-style: italic;
        }
        
        .error-state {
            padding: 20px;
            text-align: center;
            color: #721c24;
            background-color: #f8d7da;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        /* Add debug styles to better see structure */
        .scripture-content:after {
            content: "";
            display: table;
            clear: both;
        }
        
        /* Scripture footnote styling */
        .scripture-footnote {
            margin-top: 8px;
            font-size: 0.85rem;
            color: #888;
            text-align: right;
        }
        
        .scripture-ref {
            cursor: pointer;
            color: #FFA500;
            text-decoration: underline;
            font-style: italic;
        }
        
        .scripture-ref:hover {
            color: #FF8C00;
        }
        
        .scripture-excerpt {
            font-style: italic;
            padding: 15px;
            background-color: rgba(255, 165, 0, 0.1);
            border-left: 3px solid #FFA500;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        /* Message deletion controls */
        .delete-message-btn {
            display: none;
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: rgba(255, 100, 100, 0.7);
            font-size: 12px;
            cursor: pointer;
            padding: 3px;
            border-radius: 3px;
            transition: all 0.2s;
        }
        
        .message-bubble:hover .delete-message-btn {
            display: block;
        }
        
        .delete-message-btn:hover {
            background-color: rgba(255, 100, 100, 0.1);
            color: rgba(255, 50, 50, 1);
        }
    </style>
</head>
<body>
    <!-- Sidebar for conversation history -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title"><i class="fas fa-history"></i> Krishna<span>AI</span></div>
            <button class="delete-all-btn" id="delete-all-btn" title="Delete all conversations"><i class="fas fa-trash-alt"></i></button>
        </div>
        
        <!-- Sidebar tabs -->
        <div class="sidebar-tabs">
            <div class="sidebar-tab active" data-tab="conversations"><i class="fas fa-comment-dots"></i> Conversations</div>
            <div class="sidebar-tab" data-tab="scriptures"><i class="fas fa-book"></i> Scriptures</div>
        </div>
        
        <!-- Conversations Tab Content -->
        <div class="sidebar-content active" id="conversations-content">
            <div class="sort-controls">
                <select class="sort-dropdown" id="sort-conversations">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                </select>
            </div>
            <div class="conversation-list" id="conversation-list">
                <div class="empty-state">
                    <i class="fas fa-comment-dots"></i>
                    Your conversations will appear here
                </div>
            </div>
            <button class="new-chat-btn" id="new-chat-btn"><i class="fas fa-plus"></i> New Conversation</button>
        </div>
        
        <!-- Scriptures Tab Content -->
        <div class="sidebar-content" id="scriptures-content">
            <div class="scripture-list" id="scripture-list">
                <div class="empty-state">
                    <i class="fas fa-book"></i>
                    Loading scriptures...
                </div>
            </div>
            
            <!-- Scripture reading view -->
            <div class="scripture-container" id="scripture-container">
                <div class="scripture-header">
                    <button class="back-to-list-btn" id="back-to-list-btn"><i class="fas fa-arrow-left"></i> Back</button>
                    <h3 id="scripture-title"></h3>
                </div>
                <div class="scripture-content" id="scripture-content"></div>
                <div class="scripture-navigation">
                    <button id="prev-page-btn" disabled><i class="fas fa-chevron-left"></i> Previous</button>
                    <div class="page-info">Page <span id="current-page">1</span> of <span id="total-pages">1</span></div>
                    <button id="next-page-btn"><i class="fas fa-chevron-right"></i> Next</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="main-container">
        <div class="chat-header">
            <div class="menu-toggle"><i class="fas fa-bars"></i></div>
            <div class="header-title"><i class="fas fa-om krishna-icon"></i> Krishna<span>AI</span> - Spiritual Guide</div>
        </div>
        <div class="chat-container" id="chat-container">
            <!-- Chat messages will appear here -->
        </div>
        <div class="scripture-container" id="main-scripture-container">
            <div class="scripture-header">
                <div class="scripture-title" id="main-scripture-title"></div>
                <div class="scripture-controls">
                    <button class="fullscreen-btn" id="fullscreen-btn">
                        <i class="fas fa-expand"></i> Fullscreen
                    </button>
                </div>
                <button class="back-to-chat" id="back-to-chat">
                    <i class="fas fa-arrow-left"></i> Back to Chat
                </button>
            </div>
            <div class="scripture-content" id="main-scripture-content">
                <!-- Scripture content will be displayed here -->
            </div>
            <div class="scripture-navigation">
                <button class="nav-button" id="prev-page" disabled>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <div id="page-info">Page 1</div>
                <button class="nav-button" id="next-page">
                    <i class="fas fa-chevron-right"></i> Next
                </button>
            </div>
        </div>
        <div class="typing-indicator" id="typing-indicator">
            Krishna is typing...
        </div>
        <div class="input-container">
            <textarea id="user-input" placeholder="Talk to Krishna..." rows="1"></textarea>
            <button class="send-btn" id="send-btn"><i class="fas fa-paper-plane"></i> Send</button>
            <button class="reset-btn" id="reset-btn"><i class="fas fa-plus"></i></button>
        </div>
    </div>

    <!-- Add the fullscreen modal HTML right before the closing body tag -->
    <div class="scripture-modal" id="scripture-modal">
        <div class="scripture-modal-header">
            <div class="scripture-modal-title" id="modal-scripture-title"></div>
            <button class="scripture-modal-close" id="modal-close-btn">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
        <div class="scripture-modal-content" id="modal-scripture-content">
            <!-- Scripture content will be displayed here -->
        </div>
        <div class="scripture-modal-navigation">
            <button class="nav-button" id="modal-prev-page" disabled>
                <i class="fas fa-chevron-left"></i> Previous
            </button>
            <div id="modal-page-info">Page 1</div>
            <button class="nav-button" id="modal-next-page">
                <i class="fas fa-chevron-right"></i> Next
            </button>
        </div>
    </div>

    <script>
        // Feature flags
        const FEATURES = {
            SHOW_SCRIPTURES: false // Set to true to enable scriptures tab
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            const chatContainer = document.getElementById('chat-container');
            const userInput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const resetBtn = document.getElementById('reset-btn');
            const typingIndicator = document.getElementById('typing-indicator');
            const menuToggle = document.querySelector('.menu-toggle');
            const sidebar = document.querySelector('.sidebar');
            const conversationList = document.getElementById('conversation-list');
            const newChatBtn = document.getElementById('new-chat-btn');
            const sortDropdown = document.getElementById('sort-conversations');
            const body = document.querySelector('body');
            
            // Scripture elements
            const sidebarTabs = document.querySelectorAll('.sidebar-tab');
            const sidebarContents = document.querySelectorAll('.sidebar-content');
            const scriptureList = document.getElementById('scripture-list');
            const scriptureContainer = document.getElementById('scripture-container');
            const scriptureContent = document.getElementById('scripture-content');
            const scriptureTitle = document.getElementById('scripture-title');
            const currentPageEl = document.getElementById('current-page');
            const totalPagesEl = document.getElementById('total-pages');
            const prevPageBtn = document.getElementById('prev-page-btn');
            const nextPageBtn = document.getElementById('next-page-btn');
            const backToListBtn = document.getElementById('back-to-list-btn');
            
            // Main scripture elements
            const mainScriptureContainer = document.getElementById('main-scripture-container');
            const mainScriptureContent = document.getElementById('main-scripture-content');
            const mainScriptureTitle = document.getElementById('main-scripture-title');
            const pageInfo = document.getElementById('page-info');
            const backToChatBtn = document.getElementById('back-to-chat');
            const prevPage = document.getElementById('prev-page');
            const nextPage = document.getElementById('next-page');
            
            // New modal elements
            const scriptureModal = document.getElementById('scripture-modal');
            const modalScriptureTitle = document.getElementById('modal-scripture-title');
            const modalScriptureContent = document.getElementById('modal-scripture-content');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalPrevPage = document.getElementById('modal-prev-page');
            const modalNextPage = document.getElementById('modal-next-page');
            const modalPageInfo = document.getElementById('modal-page-info');
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            
            // Hide scripture-related elements if feature is disabled
            if (!FEATURES.SHOW_SCRIPTURES) {
                // Hide main scripture container
                if (mainScriptureContainer) {
                    mainScriptureContainer.style.display = 'none';
                }
                
                // Hide scripture modal
                if (scriptureModal) {
                    scriptureModal.style.display = 'none';
                }
                
                // Hide scripture content tab
                const scripturesContent = document.getElementById('scriptures-content');
                if (scripturesContent) {
                    scripturesContent.style.display = 'none';
                }
            }
            
            // Make sure main scripture container is hidden initially
            if (mainScriptureContainer) {
                mainScriptureContainer.style.display = 'none';
            }
            
            // Only load scriptures if feature is enabled
            function initializeScriptures() {
                if (!FEATURES.SHOW_SCRIPTURES) return;
                
                // Add event listeners for back buttons
                if (backToListBtn) {
                    backToListBtn.addEventListener('click', function() {
                        scriptureContainer.style.display = 'none';
                        scriptureList.style.display = 'block';
                    });
                }
                
                if (backToChatBtn) {
                    backToChatBtn.addEventListener('click', function() {
                        closeScripture();
                    });
                }
                
                // Add event listeners for navigation buttons
                if (prevPage) {
                    prevPage.addEventListener('click', function() {
                        if (currentPage > 1) {
                            loadMainScripturePage(currentScriptureId, currentPage - 1);
                        }
                    });
                }
                
                if (nextPage) {
                    nextPage.addEventListener('click', function() {
                        if (currentPage < totalPages) {
                            loadMainScripturePage(currentScriptureId, currentPage + 1);
                        }
                    });
                }
                
                // Event listeners for sidebar scripture navigation
                if (prevPageBtn) {
                    prevPageBtn.addEventListener('click', function() {
                        if (currentPage > 1) {
                            loadMainScripturePage(currentScriptureId, currentPage - 1);
                        }
                    });
                }
                
                if (nextPageBtn) {
                    nextPageBtn.addEventListener('click', function() {
                        if (currentPage < totalPages) {
                            loadMainScripturePage(currentScriptureId, currentPage + 1);
                        }
                    });
                }
                
                // Add fullscreen button event listener
                if (fullscreenBtn) {
                    fullscreenBtn.addEventListener('click', function() {
                        openFullscreenScripture(currentScriptureId, currentPage);
                    });
                }
                
                // Add modal navigation event listeners
                if (modalCloseBtn) {
                    modalCloseBtn.addEventListener('click', function() {
                        closeFullscreenScripture();
                    });
                }
                
                if (modalPrevPage) {
                    modalPrevPage.addEventListener('click', function() {
                        if (currentPage > 1) {
                            loadFullscreenScripturePage(currentScriptureId, currentPage - 1);
                        }
                    });
                }
                
                if (modalNextPage) {
                    modalNextPage.addEventListener('click', function() {
                        if (currentPage < totalPages) {
                            loadFullscreenScripturePage(currentScriptureId, currentPage + 1);
                        }
                    });
                }
                
                // Load scriptures
                loadScriptures();
            }
            
            // Initialize scriptures if feature is enabled
            initializeScriptures();
            
            // Auto-resize textarea
            userInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            
            // Send message when Enter key is pressed (unless Shift is held)
            userInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Send message when button is clicked
            sendBtn.addEventListener('click', sendMessage);
            
            // Reset conversation when button is clicked
            resetBtn.addEventListener('click', resetConversation);
            
            // Log the elements for debugging
            console.log("Main scripture container:", mainScriptureContainer);
            
            // Initialize scripture-related variables
            let currentScriptureId = null;
            let currentPage = 1;
            let totalPages = 1;
            
            let currentSessionId = null;
            let conversations = [];
            
            // Load conversations on page load
            loadConversations();
            
            // Toggle sidebar on mobile
            menuToggle.addEventListener('click', function() {
                sidebar.classList.toggle('active');
                body.classList.toggle('sidebar-open');
            });
            
            // Switch between sidebar tabs
            sidebarTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    
                    // Skip if trying to activate scriptures tab when feature is disabled
                    if (tabName === 'scriptures' && !FEATURES.SHOW_SCRIPTURES) {
                        return;
                    }
                    
                    // Update tab active state
                    sidebarTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update content visibility
                    sidebarContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(tabName + '-content').classList.add('active');
                    
                    // If switching to scriptures tab, hide chat container 
                    if (tabName === 'scriptures') {
                        // Hide chat container
                        chatContainer.style.display = 'none';
                        mainScriptureContainer.style.display = 'none';
                        
                        // Hide input container
                        document.querySelector('.input-container').style.display = 'none';
                    } else if (tabName === 'conversations') {
                        // Switch back to chat view
                        mainScriptureContainer.style.display = 'none';
                        chatContainer.style.display = 'block';
                        
                        // Show input container
                        document.querySelector('.input-container').style.display = 'flex';
                    }
                });
            });
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function(e) {
                if (window.innerWidth <= 768 && 
                    sidebar.classList.contains('active') && 
                    !sidebar.contains(e.target) && 
                    !menuToggle.contains(e.target)) {
                    sidebar.classList.remove('active');
                    body.classList.remove('sidebar-open');
                }
            });
            
            // Sort conversations when dropdown changes
            sortDropdown.addEventListener('change', function() {
                sortConversations(this.value);
            });
            
            // New conversation button
            newChatBtn.addEventListener('click', function() {
                // First close any open scripture view
                closeScripture();
                
                // Then reset the conversation
                resetConversation();
                
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('active');
                    body.classList.remove('sidebar-open');
                }
            });
            
            // Delete all conversations button
            document.getElementById('delete-all-btn').addEventListener('click', function() {
                if (confirm('Are you sure you want to delete all conversations? This cannot be undone.')) {
                    deleteAllConversations();
                }
            });
            
            function sendMessage() {
                const message = userInput.value.trim();
                if (message === '') return;
                
                // Check if this is the first message in the conversation
                const isFirstMessage = chatContainer.innerHTML.trim() === '';
                
                // Generate a unique ID for this message
                const timestamp = Date.now();
                const userMessageId = `${timestamp}_user`;
                
                // Add user message to the chat
                addMessage(message, 'user', null, userMessageId);
                
                // Clear input and reset height
                userInput.value = '';
                userInput.style.height = 'auto';
                
                // Show typing indicator
                typingIndicator.style.display = 'block';
                
                // Scroll to bottom
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // Send message to server
                fetch('/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        message: message,
                        is_first_message: isFirstMessage,
                        session_id: currentSessionId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // Hide typing indicator
                    typingIndicator.style.display = 'none';
                    
                    // Add Krishna's response to the chat
                    const krishnaMessageId = `${Date.now()}_krishna`;
                    addMessage(data.response, 'krishna', data.scripture_info || null, krishnaMessageId);
                    
                    // Update the current session ID if it's changed
                    if (data.session_id && data.session_id !== currentSessionId) {
                        currentSessionId = data.session_id;
                        localStorage.setItem('currentSessionId', currentSessionId);
                    }
                    
                    // If this was a new conversation, update the sidebar
                    if (isFirstMessage) {
                        loadConversations();
                    }
                })
                .catch(error => {
                    console.error('Error sending message:', error);
                    typingIndicator.style.display = 'none';
                    
                    // Show error message
                    const errorMsg = 'Sorry, there was an error sending your message. Please try again.';
                    addMessage(errorMsg, 'krishna');
                });
            }
            
            function addMessage(message, sender, scriptureInfo = null, messageId = null) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message');
                messageElement.classList.add(sender + '-message');
                
                // Store the message ID for deletion
                const timestamp = Date.now();
                messageId = messageId || `${timestamp}_${sender}`;
                messageElement.setAttribute('data-message-id', messageId);
                
                const bubbleElement = document.createElement('div');
                bubbleElement.classList.add('message-bubble');
                bubbleElement.classList.add(sender + '-bubble');
                
                // Create a wrapper for the message content
                const contentWrapper = document.createElement('div');
                contentWrapper.classList.add('message-content');
                
                // Add the message text
                contentWrapper.textContent = message;
                
                // Create delete button
                const deleteButton = document.createElement('button');
                deleteButton.classList.add('delete-message-btn');
                deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
                deleteButton.title = 'Delete message';
                deleteButton.style.cssText = 'display:none; border:none; background:none; color:#999; cursor:pointer; position:absolute; top:5px; right:5px; font-size:12px;';
                deleteButton.onclick = function(e) {
                    e.stopPropagation();
                    if (confirm('Are you sure you want to delete this message?')) {
                        deleteMessage(messageId);
                    }
                };
                
                // Show/hide delete button on hover
                bubbleElement.style.position = 'relative';
                bubbleElement.onmouseover = function() {
                    deleteButton.style.display = 'block';
                };
                bubbleElement.onmouseout = function() {
                    deleteButton.style.display = 'none';
                };
                
                bubbleElement.appendChild(contentWrapper);
                bubbleElement.appendChild(deleteButton);
                
                // Add scripture reference if available (only for Krishna's messages)
                if (sender === 'krishna' && scriptureInfo) {
                    const footnoteElement = document.createElement('div');
                    footnoteElement.classList.add('scripture-footnote');
                    
                    // Create footnote with scripture information
                    const scriptureSource = scriptureInfo.source;
                    const scriptureId = scriptureInfo.id;
                    const scripturePage = scriptureInfo.page || 1;
                    const scriptureExcerpt = scriptureInfo.excerpt;
                    
                    footnoteElement.innerHTML = `
                        <span class="scripture-ref" data-scripture-id="${scriptureId}" 
                                                 data-scripture-page="${scripturePage}"
                                                 data-scripture-excerpt="${scriptureExcerpt || ''}">
                            View insight from ${scriptureSource}
                        </span>
                    `;
                    
                    // Add click handler to show the scripture excerpt in a modal
                    footnoteElement.querySelector('.scripture-ref').addEventListener('click', function(e) {
                        e.preventDefault();
                        const scriptureId = this.getAttribute('data-scripture-id');
                        const scripturePage = this.getAttribute('data-scripture-page');
                        const scriptureExcerpt = this.getAttribute('data-scripture-excerpt');
                        
                        if (scriptureExcerpt) {
                            // Show the excerpt in a modal
                            showScriptureModal(scriptureSource, scriptureExcerpt);
                        } else {
                            // Open the full scripture page
                            openScriptureInMainView(scriptureId, scripturePage);
                        }
                    });
                    
                    bubbleElement.appendChild(footnoteElement);
                }
                
                messageElement.appendChild(bubbleElement);
                chatContainer.appendChild(messageElement);
                
                // Scroll to bottom
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            
            function deleteMessage(messageId) {
                fetch('/delete_message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        message_id: messageId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove the message from the UI
                        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                        if (messageElement) {
                            messageElement.remove();
                        }
                    } else {
                        console.error('Failed to delete message:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error deleting message:', error);
                });
            }
            
            function showScriptureModal(source, excerpt) {
                // Use the existing scripture modal
                const modal = document.getElementById('scripture-modal');
                const modalTitle = document.getElementById('modal-scripture-title');
                const modalContent = document.getElementById('modal-scripture-content');
                
                // Set the title and content
                modalTitle.textContent = `Insight from ${source}`;
                modalContent.innerHTML = `<div class="scripture-excerpt">${excerpt}</div>`;
                
                // Hide navigation buttons since this is just an excerpt
                document.getElementById('modal-prev-page').style.display = 'none';
                document.getElementById('modal-page-info').style.display = 'none';
                document.getElementById('modal-next-page').style.display = 'none';
                
                // Show the modal
                modal.style.display = 'block';
                
                // Prevent scrolling of the body
                document.body.style.overflow = 'hidden';
                
                // Make sure the close button works
                document.getElementById('modal-close-btn').onclick = function() {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    
                    // Restore navigation buttons for future use
                    document.getElementById('modal-prev-page').style.display = 'block';
                    document.getElementById('modal-page-info').style.display = 'block';
                    document.getElementById('modal-next-page').style.display = 'block';
                };
            }
            
            function resetConversation() {
                // Clear the entire chat container
                chatContainer.innerHTML = '';
                
                // Reset the server-side conversation
                fetch('/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update current session ID
                        currentSessionId = data.session_id;
                        // Reload conversations after reset
                        loadConversations();
                    } else {
                        console.error('Failed to reset conversation');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
            
            function loadConversations() {
                fetch('/get_conversations')
                    .then(response => response.json())
                    .then(data => {
                        if (data.sessions) {
                            conversations = data.sessions;
                            sortConversations(sortDropdown.value);
                            
                            // Check if we have a current session ID and update active state
                            if (currentSessionId) {
                                document.querySelectorAll('.conversation-item').forEach(item => {
                                    if (item.getAttribute('data-session-id') === currentSessionId) {
                                        item.classList.add('active');
                                    } else {
                                        item.classList.remove('active');
                                    }
                                });
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error loading conversations:', error);
                    });
            }
            
            function sortConversations(sortType) {
                // Clone conversations array
                const sortedConversations = [...conversations];
                
                if (sortType === 'newest') {
                    sortedConversations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                } else {
                    sortedConversations.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                }
                
                // Clear conversation list
                conversationList.innerHTML = '';
                
                // Add empty state if no conversations
                if (sortedConversations.length === 0) {
                    const emptyState = document.createElement('div');
                    emptyState.classList.add('empty-state');
                    emptyState.innerHTML = '<i class="fas fa-comment-dots"></i>Your conversations will appear here';
                    conversationList.appendChild(emptyState);
                    return;
                }
                
                // Add conversations to list
                sortedConversations.forEach(conversation => {
                    const item = document.createElement('div');
                    item.classList.add('conversation-item');
                    item.setAttribute('data-session-id', conversation.session_id);
                    
                    if (conversation.session_id === currentSessionId) {
                        item.classList.add('active');
                    }
                    
                    // Format the timestamp
                    const timestamp = new Date(conversation.timestamp);
                    const formattedDate = timestamp.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    // Create preview text (limit to 30 chars)
                    const previewText = conversation.first_message && conversation.first_message.length > 30 
                        ? conversation.first_message.substring(0, 30) + '...'
                        : conversation.first_message || 'New conversation';
                    
                    item.innerHTML = `
                        <div class="conversation-title"><i class="fas fa-comment"></i> ${previewText}</div>
                        <div class="conversation-date"><i class="far fa-clock"></i> ${formattedDate}</div>
                        <div class="conversation-controls">
                            <button class="debug-conversation-btn" title="Debug conversation" style="background: none; border: none; color: #888; cursor: pointer; padding: 3px;"><i class="fas fa-bug"></i></button>
                            <button class="force-load-btn" title="Force load" style="background: none; border: none; color: #888; cursor: pointer; padding: 3px;"><i class="fas fa-sync"></i></button>
                            <button class="delete-conversation-btn" title="Delete conversation"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    
                    // Add click event for the delete button
                    item.querySelector('.delete-conversation-btn').addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent triggering conversation switch
                        deleteConversation(conversation.session_id);
                    });
                    
                    // Add debug button event
                    item.querySelector('.debug-conversation-btn').addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent triggering conversation switch
                        window.open(`/api/debug/conversation?session_id=${conversation.session_id}`, '_blank');
                    });
                    
                    // Add force load button event
                    item.querySelector('.force-load-btn').addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent triggering conversation switch
                        forceLoadConversation(conversation.session_id);
                    });
                    
                    item.addEventListener('click', () => {
                        switchConversation(conversation.session_id);
                        if (window.innerWidth <= 768) {
                            sidebar.classList.remove('active');
                            body.classList.remove('sidebar-open');
                        }
                    });
                    
                    conversationList.appendChild(item);
                });
            }
            
            function switchConversation(sessionId) {
                // If we're already on this conversation, do nothing
                if (sessionId === currentSessionId) {
                    console.log("Already on this conversation, not switching");
                    
                    // FOR DEBUGGING: Force reload conversation content directly
                    forceLoadConversation(sessionId);
                    return;
                }
                
                // Clear the chat container
                chatContainer.innerHTML = '';
                
                // Store the session ID we're switching to
                const newSessionId = sessionId;
                
                // Switch to the selected conversation
                fetch('/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ session_id: newSessionId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update current session ID
                        currentSessionId = newSessionId;
                        console.log("Switched to session ID:", currentSessionId);
                        
                        // Update active conversation in the list
                        document.querySelectorAll('.conversation-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        
                        document.querySelectorAll('.conversation-item').forEach(item => {
                            if (item.getAttribute('data-session-id') === newSessionId) {
                                item.classList.add('active');
                            }
                        });
                        
                        // Load and display conversation messages
                        loadConversationMessages(newSessionId);
                    } else {
                        console.error('Failed to switch conversation');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
            
            // Add new helper function to directly load conversation by ID
            function forceLoadConversation(sessionId) {
                console.log("Forcing direct load of conversation:", sessionId);
                
                // Show loading state
                chatContainer.innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i> Loading conversation...</div>';
                
                // Direct API call to get messages
                fetch(`/get_conversation_messages?session_id=${sessionId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Error ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Clear existing content
                        chatContainer.innerHTML = '';
                        
                        if (data.messages && data.messages.length > 0) {
                            console.log(`Loaded ${data.messages.length} messages directly`);
                            
                            // Show each message
                            data.messages.forEach(msg => {
                                addMessage(msg.content, msg.sender === 'user' ? 'user' : 'krishna');
                            });
                        } else {
                            // Show empty state message
                            chatContainer.innerHTML = `
                                <div class="empty-state">
                                    <i class="fas fa-comment-slash"></i>
                                    <p>No messages found for this conversation.</p>
                                    <button id="force-reload-btn" class="new-chat-btn" style="margin-top:15px">
                                        <i class="fas fa-sync"></i> Force Reload
                                    </button>
                                </div>
                            `;
                            
                            // Add click event for force reload button
                            document.getElementById('force-reload-btn').addEventListener('click', () => {
                                // Try direct database fetch
                                window.open(`/api/debug/conversation?session_id=${sessionId}`, '_blank');
                            });
                        }
                    })
                    .catch(error => {
                        console.error("Error loading conversation:", error);
                        chatContainer.innerHTML = `
                            <div class="empty-state" style="color:red">
                                <i class="fas fa-exclamation-triangle"></i>
                                <p>Error loading conversation: ${error.message}</p>
                            </div>
                        `;
                    });
            }
            
            function loadConversationMessages(sessionId) {
                console.log("Loading messages for session:", sessionId);
                
                fetch(`/get_conversation_messages?session_id=${sessionId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Clear any existing messages
                        chatContainer.innerHTML = '';
                        
                        if (data.messages && data.messages.length > 0) {
                            console.log(`Loaded ${data.messages.length} messages for session ${sessionId}`);
                            
                            // Add each message to the chat
                            data.messages.forEach(msg => {
                                const sender = msg.sender === 'user' ? 'user' : 'krishna';
                                addMessage(msg.content, sender, null, msg.id);
                            });
                        } else {
                            console.warn(`No messages found for session ${sessionId}`);
                            // Add a helpful message
                            const emptyState = document.createElement('div');
                            emptyState.classList.add('empty-state');
                            emptyState.innerHTML = '<i class="fas fa-comment-dots"></i>No messages found for this conversation';
                            chatContainer.appendChild(emptyState);
                        }
                    })
                    .catch(error => {
                        console.error('Error loading conversation messages:', error);
                        // Show error message in the chat
                        const errorState = document.createElement('div');
                        errorState.classList.add('empty-state');
                        errorState.innerHTML = `<i class="fas fa-exclamation-circle"></i>Error loading conversation: ${error.message}`;
                        chatContainer.appendChild(errorState);
                    });
            }
            
            function deleteConversation(sessionId) {
                if (confirm('Are you sure you want to delete this conversation? This cannot be undone.')) {
                    fetch('/delete_conversation', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ session_id: sessionId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // If we deleted the active conversation, clear the chat
                            if (sessionId === currentSessionId) {
                                chatContainer.innerHTML = '';
                            }
                            
                            // Reload conversations
                            loadConversations();
                        } else {
                            console.error('Failed to delete conversation:', data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting conversation:', error);
                    });
                }
            }
            
            function deleteAllConversations() {
                fetch('/delete_all_conversations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Clear the chat container
                        chatContainer.innerHTML = '';
                        
                        // If the server asks us to clear local storage
                        if (data.clear_local_storage) {
                            // *** IMPROVED CACHE CLEARING ***
                            // 1. Clear localStorage
                            window.localStorage.clear();
                            
                            // 2. Clear sessionStorage
                            window.sessionStorage.clear();
                            
                            // 3. Prevent browser back button from showing deleted content
                            window.history.replaceState(null, '', window.location.href);
                            
                            // 4. Force reload the page to clear any in-memory cache
                            setTimeout(() => {
                                window.location.reload(true); // true = force reload from server
                            }, 100);
                            
                            console.log('Cleared all conversation data completely');
                        }
                        
                        // Set the active session to the new one if provided
                        if (data.new_session_id) {
                            currentSessionId = data.new_session_id;
                            localStorage.setItem('currentSessionId', currentSessionId);
                        }
                    } else {
                        console.error('Failed to delete all conversations:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error deleting all conversations:', error);
                });
            }
            
            function loadScriptures() {
                fetch('/get_scriptures')
                    .then(response => response.json())
                    .then(data => {
                        if (data.scriptures) {
                            // Store scriptures globally
                            window.scriptures = data.scriptures;
                            renderScriptureList();
                        }
                    })
                    .catch(error => {
                        console.error('Error loading scriptures:', error);
                        scriptureList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-exclamation-circle"></i>
                                Error loading scriptures
                            </div>
                        `;
                    });
            }
            
            function renderScriptureList() {
                scriptureList.innerHTML = '';
                
                const scriptures = window.scriptures || [];
                
                if (scriptures.length === 0) {
                    scriptureList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-book"></i>
                            No scriptures available
                        </div>
                    `;
                    return;
                }
                
                scriptures.forEach(scripture => {
                    const item = document.createElement('div');
                    item.classList.add('scripture-item');
                    
                    item.innerHTML = `
                        <div class="scripture-title">
                            <i class="fas fa-book"></i> ${scripture.name}
                        </div>
                    `;
                    
                    item.addEventListener('click', () => {
                        openScriptureInMainView(scripture.id, 1);
                        
                        // Close sidebar on mobile
                        if (window.innerWidth <= 768) {
                            sidebar.classList.remove('active');
                            body.classList.remove('sidebar-open');
                        }
                    });
                    
                    scriptureList.appendChild(item);
                });
            }
            
            function openScriptureInMainView(scriptureId, page) {
                console.log("Opening scripture:", scriptureId, "page:", page);
                
                // Hide chat container and show scripture container
                chatContainer.style.display = 'none';
                mainScriptureContainer.style.display = 'flex';
                
                // Hide input container when viewing scripture
                document.querySelector('.input-container').style.display = 'none';
                
                // Load the scripture content
                loadMainScripturePage(scriptureId, page);
            }
            
            function loadMainScripturePage(scriptureId, page = 1) {
                currentScriptureId = scriptureId;
                currentPage = page;
                
                console.log("Loading scripture page:", scriptureId, page);
                
                // Clear content and show loading state
                mainScriptureContent.innerHTML = `<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading scripture...</div>`;
                
                // Make sure the scripture container is visible
                mainScriptureContainer.style.display = 'flex';
                chatContainer.style.display = 'none';
                
                // Fetch the scripture content
                fetch(`/get_scripture/${scriptureId}?page=${page}`)
                    .then(response => {
                        console.log("Response status:", response.status);
                        if (!response.ok) {
                            throw new Error('Failed to load scripture');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Scripture data received:", data); // Debug logging
                        if (data.success) {
                            // Update title and content
                            mainScriptureTitle.textContent = data.title;
                            
                            // Format and display the content
                            let formattedContent = '';
                            if (data.verses && data.verses.length > 0) {
                                // Add debug info (can be removed in production)
                                formattedContent += `<div class="scripture-debug">Page ${page} of ${data.total_pages || 1}</div>`;
                                
                                // Process each verse with improved formatting
                                data.verses.forEach(verse => {
                                    // Process text to handle line breaks better and remove extra whitespace
                                    let processedText = verse.text
                                        .replace(/\s+/g, ' ')  // Normalize whitespace
                                        .trim();
                                        
                                    formattedContent += `<p><span class="verse-num">${verse.verse_num}</span> ${processedText}</p>`;
                                });
                            }
                            
                            formattedContent += `<div class="scripture-content">${data.content}</div>`;
                            
                            // Update content
                            mainScriptureContent.innerHTML = formattedContent;
                        } else {
                            console.error('Failed to load scripture:', data.error);
                            mainScriptureContent.innerHTML = `
                                <div class="empty-state">
                                    <i class="fas fa-exclamation-circle"></i>
                                    Error loading scripture: ${data.error}
                                </div>
                            `;
                        }
                    })
                    .catch(error => {
                        console.error("Error loading scripture:", error);
                        mainScriptureContent.innerHTML = `
                            <div class="empty-state" style="color:red">
                                <i class="fas fa-exclamation-triangle"></i>
                                <p>Error loading scripture: ${error.message}</p>
                            </div>
                        `;
                    });
            }
            
            function closeScripture() {
                mainScriptureContainer.style.display = 'none';
                chatContainer.style.display = 'block';
                document.querySelector('.input-container').style.display = 'flex';
            }
            
            function openFullscreenScripture(scriptureId, page) {
                loadMainScripturePage(scriptureId, page);
                mainScriptureContainer.style.display = 'none';
                chatContainer.style.display = 'none';
                document.querySelector('.input-container').style.display = 'none';
            }
            
            function loadFullscreenScripturePage(scriptureId, page) {
                loadMainScripturePage(scriptureId, page);
                mainScriptureContainer.style.display = 'none';
                chatContainer.style.display = 'none';
                document.querySelector('.input-container').style.display = 'none';
            }
            
            function closeFullscreenScripture() {
                mainScriptureContainer.style.display = 'none';
                chatContainer.style.display = 'block';
                document.querySelector('.input-container').style.display = 'flex';
            }
        });
    </script>
</body>
</html>